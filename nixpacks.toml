# Nixpacks configuration for Next.js application

[phases.setup]
# Install Nix packages and enable caching for repeated builds
nixPkgs = ["nodejs"]
cacheDirectories = ["~/.cache/nix"]

[phases.install]
cmds = ["npm ci"]
cacheDirectories = ["~/.npm", "node_modules", "node_modules/.cache"]
onlyIncludeFiles = ["package.json", "package-lock.json"]

[phases.build]
cmds = ["npm run build"]
cacheDirectories = [".next/cache", "node_modules/.cache"]


[phases.convex-deploy]
dependsOn = ["build"]
# Only deploy Convex functions when Convex-related files change
cmds = ["bash tools/convex-deploy-if-changed.sh"]
onlyIncludeFiles = ["convex/**", "tools/convex-deploy-if-changed.sh", "package.json", "package-lock.json"]

[start]
cmd = "npm run start"
runImage = "node:22-bullseye-slim"
onlyIncludeFiles = [".next", "public", "package.json", "node_modules"]
